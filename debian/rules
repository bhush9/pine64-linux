#!/usr/bin/make -f

%:
	dh $@ --parallel

override_dh_auto_configure:
	$(MAKE) VERBOSE=1 sun50iw1p1smp_linux_defconfig
	dh_auto_configure

override_dh_auto_build:
	dh_auto_build -- V=1 Image modules
	LICHEE_KDIR=$(CURDIR) LICHEE_PLATFORM=Pine64 make -C $(CURDIR)/modules/gpu build

override_dh_auto_clean:
	$(MAKE) clean

KERNEL_VERSION := $(shell cat $(CURDIR)/include/config/kernel.release)

override_dh_auto_install:
	mkdir -p debian/tmp/boot/
	INSTALL_PATH=debian/tmp/boot/ dh_auto_install
	$(MAKE) V=1 INSTALL_MOD_PATH=debian/tmp/ INSTALL_MOD_STRIP=1 modules_install firmware_install
	mkdir -p debian/tmp/lib/modules/$(KERNEL_VERSION)/kernel/extramodules/
	cp -v $(CURDIR)/modules/gpu/mali400/kernel_mode/driver/src/devicedrv/mali/mali.ko debian/tmp/lib/modules/$(KERNEL_VERSION)/kernel/extramodules
	depmod -b debian/tmp $(KERNEL_VERSION)
